---
title: "Final Project"
author: "Yihong Hu & Shujing Yi"
date: "4/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidycensus)
library(tidyverse)
library(ggplot2)
library(mapview)
library(lubridate)

census_api_key("94efffd19b56ad527e379faea1653ee74dc3de4a",overwrite = TRUE)
```

# Introduction

# Data Wrangling

```{r cars}

#Philly Street Light Poles
Street_Poles_Data <- st_read("https://opendata.arcgis.com/datasets/9059a7546b6a4d658bef9ce9c84e4b03_0.geojson") 

Street_Poles_Lumen <- Street_Poles_Data %>% select(LUM_SIZE) %>% na.omit()

# Philly Census
Philly_Census <- get_acs(geography = "block group",
                         state = 42,
                         county = 101,
                         year = 2019,
                         geometry = TRUE,
                         variable = "B19013_001")
          

Report_311_2020 <-
  read.csv("public_cases_2020.csv")%>%
  filter(service_name=="Street Light Outage")

Report_311_2019 <-
  read.csv("public_cases_2019.csv") %>%
  filter(service_name=="Street Light Outage")

Report_311_2018 <-
  read.csv("public_cases_fc_2018.csv") %>%
  filter(service_name=="Street Light Outage")

Report_light_out <-
  rbind(Report_311_2018,Report_311_2019,Report_311_2020)%>%na.omit %>%
  st_as_sf(coords = c("lon","lat"),crs = 4326) %>%
  distinct(updated_datetime, .keep_all = T) 

Crash <-
  st_read("https://opendata.arcgis.com/api/v3/datasets/e703eb63ec484aa6beae1268372efa53_0/downloads/data?format=geojson&spatialRefId=4326")

head(Crash)

Crash_Ped_PennDot <-
  Crash %>%
  filter(PED_COUNT > 0)

Crash_Ped_PennDot$HOUR_OF_DA <- as.character(Crash_Ped_PennDot$HOUR_OF_DA)

Crash_Ped_PennDot %>%
  mutate(HOUR_DA_FACTOR = factor(HOUR_OF_DA, levels = c(as.character(seq(0,24)))))%>%
  group_by(HOUR_DA_FACTOR)%>%
  tally()%>%
  group_by(HOUR_DA_FACTOR)%>%
  summarise(SUM_HOUR = sum(n)) %>%
  filter(!HOUR_DA_FACTOR == "99")%>%
ggplot(aes(HOUR_DA_FACTOR, SUM_HOUR, fill=HOUR_DA_FACTOR)) + 
         geom_bar(position = "dodge", stat = "summary", fun.y = "mean") 

Crash_Ped_PennDot$HOUR_OF_DA <- as.numeric(Crash_Ped_PennDot$HOUR_OF_DA)

Crash_Ped_PennDot_sum <-
  Crash_Ped_PennDot %>%
  mutate(TIME_OF_DAY = case_when(HOUR_OF_DA < 7 | HOUR_OF_DA > 18 ~ "Overnight",
                                 HOUR_OF_DA >= 7 & HOUR_OF_DA < 10 ~ "AM Rush",
                                 HOUR_OF_DA >= 10 & HOUR_OF_DA < 15 ~ "Mid-Day",
                                 HOUR_OF_DA >= 15 & HOUR_OF_DA <= 18 ~ "PM Rush"))%>%
  group_by(HOUR_OF_DA, TIME_OF_DAY) %>%
  tally() %>%
  group_by(TIME_OF_DAY) %>%
  summarise(sum_crash = sum(n))%>%
  mutate(pct_crash = sum_crash/sum(sum_crash)*100)

Crash_Ped_PennDot_sum %>%
  ggplot(aes(TIME_OF_DAY, sum_crash, fill = TIME_OF_DAY))+
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean")

Crash_Ped_PennDot_Fatal <-
  Crash_Ped_PennDot %>%
  filter(FATAL_COUN > 0)

Crash_Ped_PennDot_Fatal_sum <-
Crash_Ped_PennDot_Fatal %>%
  mutate(TIME_OF_DAY = case_when(HOUR_OF_DA < 7 | HOUR_OF_DA > 18 ~ "Overnight",
                                 HOUR_OF_DA >= 7 & HOUR_OF_DA < 10 ~ "AM Rush",
                                 HOUR_OF_DA >= 10 & HOUR_OF_DA < 15 ~ "Mid-Day",
                                 HOUR_OF_DA >= 15 & HOUR_OF_DA <= 18 ~ "PM Rush"))%>%
  group_by(HOUR_OF_DA, TIME_OF_DAY) %>%
  tally() %>%
  group_by(TIME_OF_DAY) %>%
  summarise(sum_crash = sum(n))%>%
  mutate(pct_crash = sum_crash/sum(sum_crash)*100)

Crash_Ped_PennDot_Fatal_sum %>%
  ggplot(aes(TIME_OF_DAY, sum_crash, fill = TIME_OF_DAY))+
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean")

Crash_Ped_PennDot_Fatal_overnight <-
  Crash_Ped_PennDot_Fatal %>%
  mutate(TIME_OF_DAY = case_when(HOUR_OF_DA < 7 | HOUR_OF_DA > 18 ~ "Overnight",
                                 HOUR_OF_DA >= 7 & HOUR_OF_DA < 10 ~ "AM Rush",
                                 HOUR_OF_DA >= 10 & HOUR_OF_DA < 15 ~ "Mid-Day",
                                 HOUR_OF_DA >= 15 & HOUR_OF_DA <= 18 ~ "PM Rush"))%>%
  filter(TIME_OF_DAY=="Overnight")%>%
  group_by(ILLUMINATI)%>%
  tally()%>%
  group_by(ILLUMINATI)%>%
  summarize(ILLUMINATI_SUM = sum(n))%>%
  mutate(pct_ill = ILLUMINATI_SUM/sum(ILLUMINATI_SUM) * 100)

Crash_Ped_PennDot_Fatal_overnight$ILLUMINATI <- as.character(Crash_Ped_PennDot_Fatal_overnight$ILLUMINATI)

Crash_Ped_PennDot_Fatal_overnight %>%
  ggplot(aes(ILLUMINATI,ILLUMINATI_SUM,fill=ILLUMINATI))+
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean")
  
  Crash_Fatal_PennDot <-
  Crash%>%
  filter(FATAL_COUN > 0)

Fatal_Crash <-
  st_read("https://opendata.arcgis.com/datasets/6510bfe4d500460caef528511d084335_0.geojson")

Fatal_Crash2 <-
  Fatal_Crash %>%
  mutate(interval60 = floor_date(ymd_hms(DATE_), unit = "hour"))

filter 
ggplot()+
  geom_sf(data = Philly_Census,color = "grey30")+
  geom_sf(data = Street_Poles, aes(color = LUM_SIZE))

glimpse(Street_Poles)

unique(Report_311_2018$service_name)

ggplot(street_poles, x=)+
  geom_sf(data = Street_Poles)


taxi drop-off as transit grows
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
